steps:
- name: 'gcr.io/cloud-builders/docker'
  id: build
  entrypoint: 'sh'
  args:
  - '-c'
  - 'docker build
     --build-arg COMMIT1=${_COMMIT_1}
     --build-arg COMMIT2=${_COMMIT_2}
     -t gcr.io/$PROJECT_ID/geth-multi:${_COMMIT_1}-${_COMMIT_2}
     -f tests/nightly/multiversion/Dockerfile.multiversion
     . '

- name: 'gcr.io/cloud-builders/docker'
  id: push
  entrypoint: 'sh'
  args:
  - '-c'
  - 'docker push
     gcr.io/$PROJECT_ID/geth-multi:${_COMMIT_1}-${_COMMIT_2}
     '
  waitFor:
  - 'build'

- name: 'gcr.io/$PROJECT_ID/helm'
  id: deploy
  entrypoint: 'sh'
  args:
  - '-c'
  - '/builder/helm.bash
     install celo/testnet
     --name nightlygethmultiversion
     --namespace nightlygethmultiversion
     --values tests/nightly/multiversion/multiversion_values.yaml
     --set geth.image.tag=${_COMMIT_1}-${_COMMIT_2} 
     --set-file genesis.genesisFile=tests/nightly/genesis.json
     '
  waitFor:
  - 'push'
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=us-west1-a'
  - 'CLOUDSDK_CONTAINER_CLUSTER=celo-networks-dev'
  - 'HELM_REPO_NAME=celo'
  - 'HELM_REPO_URL=https://celo-org.github.io/infrastructure/helm-charts'
  - 'TILLERLESS=true'
  - 'TILLER_NAMESPACE=tillercimultiversion'
  - 'DEBUG=true'

- name: 'ubuntu'
  id: sleep
  args:
  - sleep
  - '600'
  waitFor:
  - 'deploy'

- name: 'alpine'
  id: download
  entrypoint: "sh"
  args:
  - "-c"
  - |
      mkdir -p /workspace
      wget -O /workspace/health_check https://storage.googleapis.com/jcortejoso_temp_bucket/health_check
      chmod +x /workspace/health_check
  waitFor:
  - 'sleep'

- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  id: check
  entrypoint: "bash"
  args:
  - "-c"
  - |
      gcloud container clusters get-credentials $$CLOUDSDK_CONTAINER_CLUSTER --region $$CLOUDSDK_COMPUTE_ZONE
      kubectl port-forward -n nightlygethmultiversion nightlygethmultiversion-validators-0 8545 &
      sleep 5
      /workspace/health_check --rpc http://127.0.0.1:8545 --epoch 280 --first-block 1 --last-block 281
  waitFor:
  - 'download'
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=us-west1-a'
  - 'CLOUDSDK_CONTAINER_CLUSTER=celo-networks-dev'

- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  id: clean
  entrypoint: "bash"
  args:
  - "-c"
  - |
      gcloud container clusters get-credentials $$CLOUDSDK_CONTAINER_CLUSTER --region $$CLOUDSDK_COMPUTE_ZONE
      kubectl delete ns tillercimultiversion nightlygethmultiversion
  waitFor:
  - 'check'
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=us-west1-a'
  - 'CLOUDSDK_CONTAINER_CLUSTER=celo-networks-dev'

substitutions:
  _COMMIT_1: 1.0.1 # default value
  _COMMIT_2: master # default value

timeout: 2700s
