steps:
- name: 'gcr.io/$PROJECT_ID/helm'
  id: deploy_testnet
  entrypoint: 'sh'
  args:
  - '-c'
  - '/builder/helm.bash
     install celo/testnet
     --name nightlyloadtests
     --namespace nightlyloadtests
     --values tests/nightly/loadtests/testnet_values.yaml
     --set-file genesis.genesisFile=tests/nightly/loadtests/genesis.json
     '
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=us-west1-a'
  - 'CLOUDSDK_CONTAINER_CLUSTER=celo-networks-dev'
  - 'HELM_REPO_NAME=celo'
  - 'HELM_REPO_URL=https://celo-org.github.io/infrastructure/helm-charts'
  - 'TILLERLESS=true'
  - 'TILLER_NAMESPACE=tillerciloadtests'
  - 'DEBUG=true'

- name: 'ubuntu'
  id: sleep1
  args:
  - sleep
  - '200'
  waitFor:
  - 'deploy_testnet'

- name: 'gcr.io/$PROJECT_ID/helm'
  id: deploy_loadtest
  entrypoint: 'sh'
  args:
  - '-c'
  - '/builder/helm.bash
     install celo/load-test
     --name nightlyloadtests-loadtests
     --namespace nightlyloadtests
     --values tests/nightly/loadtests/loadtests_values.yaml
     '
  waitFor:
  - 'sleep1'
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=us-west1-a'
  - 'CLOUDSDK_CONTAINER_CLUSTER=celo-networks-dev'
  - 'HELM_REPO_NAME=celo'
  - 'HELM_REPO_URL=https://celo-org.github.io/infrastructure/helm-charts'
  - 'TILLERLESS=true'
  - 'TILLER_NAMESPACE=tillerciloadtests'
  - 'DEBUG=true'

- name: 'ubuntu'
  id: sleep2
  args:
  - sleep
  - '200'
  waitFor:
  - 'deploy_loadtest'

- name: 'alpine'
  id: download
  entrypoint: "sh"
  args:
  - "-c"
  - |
      mkdir -p /workspace
      wget -O /workspace/health_check https://storage.googleapis.com/jcortejoso_temp_bucket/health_check
      chmod +x /workspace/health_check
  waitFor:
  - 'sleep2'

- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  id: check
  entrypoint: "bash"
  args:
  - "-c"
  - |
      gcloud container clusters get-credentials $$CLOUDSDK_CONTAINER_CLUSTER --region $$CLOUDSDK_COMPUTE_ZONE
      kubectl port-forward -n nightlyloadtests nightlyloadtests-validators-0 8545 &
      sleep 5
      /workspace/health_check --rpc http://127.0.0.1:8545 --epoch 280 --first-block 700 --last-block 1000 --block-time 5.0 --avg-delay 0.0 --avg-misses 0.001
  waitFor:
  - 'download'
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=us-west1-a'
  - 'CLOUDSDK_CONTAINER_CLUSTER=celo-networks-dev'

- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  id: clean
  entrypoint: "bash"
  args:
  - "-c"
  - |
      gcloud container clusters get-credentials $$CLOUDSDK_CONTAINER_CLUSTER --region $$CLOUDSDK_COMPUTE_ZONE
      kubectl delete ns tillerciloadtests nightlyloadtests
  waitFor:
  - 'check'
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=us-west1-a'
  - 'CLOUDSDK_CONTAINER_CLUSTER=celo-networks-dev'

timeout: 7200s
